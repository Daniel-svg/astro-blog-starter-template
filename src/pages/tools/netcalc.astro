---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';

const title = '網段計算機';
const description = '網段計算機，提供快速查詢可用IP位址、子網遮罩與廣播地址。';
---

<!doctype html>
<html lang="zh-Hant">
<head>
    <BaseHead title={title} description={SITE_DESCRIPTION} />

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6026639928482840" crossorigin="anonymous"></script>

    <style>
        main {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .calculator-container {
            background: #ffffff;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,.1);
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        h1 {
            font-size: 2rem;
            color: #0056b3;
            margin-bottom: 1.5rem;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        @media (min-width: 768px) {
            .input-group { flex-direction: row; }
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            transition: 0.3s;
            font-family: 'Inter', monospace;
        }
        input[type="text"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,.25);
            outline: none;
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            width: 100%;
            margin-top: 10px;
            font-weight: bold;
        }
        button[onclick="calculate()"] {
            background: #007bff;
            color: #fff;
        }
        button[onclick="calculate()"]:hover {
            background: #0056b3;
        }
        .toggle-bin {
            display: inline-block;
            padding: 8px 15px;
            background: #f1f1f1;
            color: #555;
            border-radius: 6px;
            margin-top: 15px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }
        .toggle-bin:hover {
            background: #e0e0e0;
        }
        .results {
            margin-top: 25px;
            text-align: left;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px dashed #ced4da;
        }
        .results > div {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-family: 'Inter', monospace;
        }
        .results > div:last-child { border-bottom: none; }
        .results strong {
            width: 150px;
            font-weight: 600;
            color: #333;
        }
        .error-message {
            color: #dc3545;
            font-weight: bold;
            padding: 10px;
            text-align: center;
        }
    </style>
</head>

<body>
    <Header />

    <main>
        <div class="calculator-container">
            <h1>{title}</h1>

            <div class="input-group">
                <input type="text" id="cidrInput" placeholder="IP/子網 (例: 192.168.1.10/24)">
                <input type="text" id="maskInput" placeholder="子網遮罩 (例: 255.255.255.0)">
            </div>

            <button onclick="calculate()">計算</button>
            <div class="toggle-bin" id="toggleBinaryButton" onclick="toggleBinary()">切換二進位顯示</div>

            <div class="results" id="results">
                <div style="justify-content:center;color:#6c757d;border-bottom:none;">
                    請輸入 IP 地址開始計算
                </div>
            </div>
        </div>
    </main>

    <Footer />

    <script>
        function ipToInt(ipArr){
            return (ipArr[0]>>>0)*256*256*256 +
                   (ipArr[1]>>>0)*256*256 +
                   (ipArr[2]>>>0)*256 +
                   (ipArr[3]>>>0);
        }

        function intToIp(int){
            return [
                (int>>>24)&255,
                (int>>>16)&255,
                (int>>>8)&255,
                int&255
            ];
        }

        function ipToBinary(ip){
            return ip.split('.').map(n => parseInt(n).toString(2).padStart(8,"0")).join('.');
        }

        function isPrivateIP(ip){
            const [a,b] = ip.split('.').map(n => parseInt(n));
            if(a===10) return "私有網段 (A 類)";
            if(a===172 && b>=16 && b<=31) return "私有網段 (B 類)";
            if(a===192 && b===168) return "私有網段 (C 類)";
            if(a===127) return "迴圈本地 (Loopback)";
            if(a>=224 && a<=239) return "多播地址 (Multicast)";
            return "公網IP";
        }

        let showBinary = false;

        function calculate(){
            const cidrInput = document.getElementById('cidrInput').value.trim();
            const maskVal = document.getElementById('maskInput').value.trim();
            const results = document.getElementById('results');

            let ip, mask, prefix;

            if(cidrInput.includes('/')){
                [ip, prefix] = cidrInput.split('/');
                prefix = parseInt(prefix);

                mask = Array(4).fill(0).map((_,i)=>{
                    let rem = prefix - i*8;
                    if(rem>=8) return 255;
                    if(rem<=0) return 0;
                    return 256 - Math.pow(2, 8-rem);
                }).join('.');
            }
            else if(cidrInput && maskVal){
                ip = cidrInput;
                mask = maskVal;
                prefix = mask.split('.')
                              .map(n => parseInt(n).toString(2).replace(/0/g,"").length)
                              .reduce((a,b)=>a+b,0);
            }
            else {
                results.innerHTML = `<div class="error-message">請輸入有效 IP 或 CIDR</div>`;
                return;
            }

            const ipParts = ip.split('.').map(n => parseInt(n));
            const maskParts = mask.split('.').map(n => parseInt(n));

            if(ipParts.some(n=>isNaN(n)||n<0||n>255)
            || maskParts.some(n=>isNaN(n)||n<0||n>255)
            || prefix<0 || prefix>32){
                results.innerHTML = `<div class="error-message">輸入格式錯誤 (IP 0–255, CIDR 0–32)</div>`;
                return;
            }

            const network = ipParts.map((n,i)=> n & maskParts[i]);
            const wildcard = maskParts.map(n => (~n & 255));
            const broadcast = network.map((n,i)=> n | wildcard[i]);

            const netInt = ipToInt(network);
            const bcInt  = ipToInt(broadcast);

            let hostMinInt, hostMaxInt, hostCount = Math.pow(2, 32-prefix);

            if(prefix === 32){
                hostMinInt = hostMaxInt = netInt;
                hostCount = 1;
            } else if(prefix === 31){
                hostMinInt = netInt;
                hostMaxInt = bcInt;
                hostCount = 2;
            } else {
                hostMinInt = netInt + 1;
                hostMaxInt = bcInt - 1;
                hostCount -= 2;
            }

            const hostMin = intToIp(hostMinInt);
            const hostMax = intToIp(hostMaxInt);

            function display(arr){
                const s = arr.join('.');
                return showBinary ? `${ipToBinary(s)} (${s})` : s;
            }

            function displayMask(m){
                return showBinary ? `${ipToBinary(m)} (${m})` : m;
            }

            results.innerHTML = `
                <div><strong>輸入 IP:</strong><span>${display(ipParts)}</span></div>
                <div><strong>子網遮罩 (Mask):</strong><span>${displayMask(mask)}</span></div>
                <div><strong>子網位元 (CIDR):</strong><span>/${prefix}</span></div>
                <div><strong>IP 類型:</strong><span>${isPrivateIP(ip)}</span></div>

                <div style="margin-top:10px;border-top:2px solid #ddd;">
                    <strong>網段位址 (Network ID):</strong>
                    <span>${display(network)}</span>
                </div>

                <div><strong>廣播位址 (Broadcast):</strong><span>${display(broadcast)}</span></div>
                <div><strong>可用主機範圍:</strong><span>${display(hostMin)} - ${display(hostMax)}</span></div>
                <div><strong>可用主機數量:</strong><span>${hostCount}</span></div>
            `;
        }

        function toggleBinary(){
            showBinary = !showBinary;
            document.getElementById('toggleBinaryButton').textContent =
                showBinary ? "切換為十進位顯示" : "切換二進位顯示";

            calculate();
        }
    </script>
</body>
</html>
