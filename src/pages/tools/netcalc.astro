---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';

const title = '網段計算機';
const description = '網段計算機，提供快速查詢可用IP位址、子網遮罩與廣播地址。';
---

<!doctype html>
<html lang="zh-Hant">
<head>
    <BaseHead title={title} description={description} />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      crossorigin="anonymous"
    />

    <!-- Google Ads -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6026639928482840"
      crossorigin="anonymous"
    ></script>

    <style>
      /* 基礎重置 & 頁面安全 */
      html, body {
        overflow-x: hidden;
        font-family: "Noto Sans TC", sans-serif;
      }

      main {
        max-width: 900px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      /* ===== 卡片容器 ===== */
      .calculator-container {
        background: #fff;
        padding: 3rem;
        border-radius: 18px;
        border: 1px solid #efefef;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
        text-align: center;
      }

      @media (max-width: 500px) {
        .calculator-container {
          padding: 1.6rem;
        }
      }

      h1 {
        font-size: 2.2rem;
        color: #3c4043;
        margin-bottom: 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
      }

      h1 i {
        color: #4285f4;
      }

      /* ===== 輸入欄位 ===== */
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
      }

      @media (min-width: 768px) {
        .input-group {
          flex-direction: row;
        }
      }

      input[type="text"] {
        flex-grow: 1;
        padding: 14px 18px;
        border: 1px solid #dadce0;
        border-radius: 8px;
        font-size: 1.1rem;
        font-family: 'Roboto Mono', monospace;
        transition: 0.25s;
      }

      input[type="text"]:focus {
        border-color: #4285f4;
        box-shadow: 0 0 0 1px #4285f4;
        outline: none;
      }

      /* 按鈕 - 計算 */
      button.calculate-btn {
        padding: 14px 25px;
        border: none;
        border-radius: 8px;
        background: #4285f4;
        color: #fff;
        font-size: 1.1rem;
        font-weight: 500;
        cursor: pointer;
        transition: 0.3s;
        width: 100%;
        margin-top: 10px;
      }

      button.calculate-btn:hover {
        background: #3367d6;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      /* 二進位切換按鈕 */
      .toggle-bin {
        display: inline-flex;
        align-items: center;
        padding: 10px 20px;
        background: #f1f3f4;
        color: #5f6368;
        border-radius: 8px;
        margin-top: 15px;
        cursor: pointer;
        transition: 0.3s;
        font-size: 0.95rem;
      }

      .toggle-bin:hover {
        background: #e8eaed;
        color: #202124;
      }

      .toggle-bin i {
        margin-right: 8px;
        color: #5f6368;
      }

      /* ===== 結果區塊 ===== */
      .results {
        margin-top: 30px;
        text-align: left;
      }

      .results > div {
        padding: 12px 15px;
        border-bottom: 1px solid #efefef;
        background: #fcfcfc;
        border-radius: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: center;
        margin-bottom: 6px;
      }

      /* 重要結果 */
      .primary-result {
        background: #e8f0fe !important;
        border-left: 5px solid #4285f4;
        font-weight: 700;
      }

      .results strong {
        color: #3c4043;
        font-weight: 500;
        display: block;
        width: 100%;
        margin-bottom: 4px;
      }

      @media (min-width: 600px) {
        .results strong {
          width: 220px;
          margin-bottom: 0;
        }
      }

      .results span {
        font-family: 'Roboto Mono', monospace;
        word-break: break-word;
        overflow-wrap: break-word;
        font-size: 1rem;
      }

      .binary-val {
        display: block;
        margin-bottom: 2px;
      }

      .error-message {
        color: #c00;
        font-weight: bold;
        text-align: center;
        padding: 15px;
      }
    </style>
</head>

<body>
    <Header />

    <main>
      <div class="calculator-container">
        
        <h1><i class="fas fa-network-wired"></i> 網段計算機</h1>

        <!-- 輸入欄位 -->
        <div class="input-group">
          <input type="text" id="cidrInput" placeholder="IP/子網 (例: 192.168.1.10/24)">
          <input type="text" id="maskInput" placeholder="或子網遮罩 (例: 255.255.255.0)">
        </div>

        <button class="calculate-btn" onclick="calculate()">
          <i class="fas fa-calculator"></i> 開始計算
        </button>

        <div class="toggle-bin" id="toggleBinaryButton" onclick="toggleBinary()">
          <i class="fas fa-exchange-alt"></i> 切換二進位顯示
        </div>

        <!-- 結果區 -->
        <div class="results" id="results">
          <div style="text-align:center; border-bottom:none; background:transparent;">
            <i class="fas fa-mouse-pointer"></i> 請輸入 IP 地址開始計算
          </div>
        </div>
      </div>
    </main>

    <Footer />

    <!-- JS -->
    <script is:inline>
      /* 你原本的 JS 已保留，只做縮排與小幅優化 */
      function ipToInt(ipArr){
        return (ipArr[0]>>>0)*16777216 +
               (ipArr[1]>>>0)*65536 +
               (ipArr[2]>>>0)*256 +
               (ipArr[3]>>>0);
      }

      function intToIp(int){
        return [
          (int>>>24)&255,
          (int>>>16)&255,
          (int>>>8)&255,
          int&255
        ];
      }

      function ipToBinary(ip){
        return ip.split('.')
          .map(n => parseInt(n).toString(2).padStart(8, "0"))
          .join('.');
      }

      function isPrivateIP(ip){
        const [a,b] = ip.split('.').map(Number);
        if(a===10) return "私有網段 (A 類)";
        if(a===172 && b>=16 && b<=31) return "私有網段 (B 類)";
        if(a===192 && b===168) return "私有網段 (C 類)";
        if(a===127) return "迴圈本地 (Loopback)";
        if(a>=224 && a<=239) return "多播地址 (Multicast)";
        return "公網IP";
      }

      let showBinary = false;

      function calculate(){
        const cidrInput = document.getElementById('cidrInput').value.trim();
        const maskVal   = document.getElementById('maskInput').value.trim();
        const results   = document.getElementById('results');

        let ip, mask, prefix;

        if(cidrInput.includes('/')){
          [ip, prefix] = cidrInput.split('/');
          prefix = parseInt(prefix);

          mask = Array(4).fill(0).map((_,i)=>{
            let rem = prefix - i*8;
            if(rem>=8) return 255;
            if(rem<=0) return 0;
            return 256 - Math.pow(2, 8-rem);
          }).join('.');
        }
        else if(cidrInput && maskVal){
          ip = cidrInput;
          mask = maskVal;
          prefix = mask.split('.')
                       .map(n => parseInt(n).toString(2).replace(/0/g,"").length)
                       .reduce((a,b)=>a+b,0);
        }
        else {
          results.innerHTML =
            `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> 請輸入有效 IP 或 CIDR</div>`;
          return;
        }

        const ipParts   = ip.split('.').map(Number);
        const maskParts = mask.split('.').map(Number);

        if(ipParts.some(n=>isNaN(n)||n<0||n>255)
        || maskParts.some(n=>isNaN(n)||n<0||n>255)
        || prefix<0 || prefix>32){
          results.innerHTML =
            `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> 輸入格式錯誤 (IP 0–255, CIDR 0–32)</div>`;
          return;
        }

        const network   = ipParts.map((n,i)=> n & maskParts[i]);
        const wildcard  = maskParts.map(n => (~n & 255));
        const broadcast = network.map((n,i)=> n | wildcard[i]);

        const netInt = ipToInt(network);
        const bcInt  = ipToInt(broadcast);

        let hostMinInt, hostMaxInt, hostCount = Math.pow(2, 32-prefix);

        if(prefix === 32){
          hostMinInt = hostMaxInt = netInt;
          hostCount = 1;
        } else if(prefix === 31){
          hostMinInt = netInt;
          hostMaxInt = bcInt;
          hostCount = 2;
        } else {
          hostMinInt = netInt + 1;
          hostMaxInt = bcInt - 1;
          hostCount -= 2;
        }

        const hostMin = intToIp(hostMinInt);
        const hostMax = intToIp(hostMaxInt);

        function display(arr){
          const str = arr.join('.');
          return showBinary
            ? `<span class="binary-val">${ipToBinary(str)}</span><span>(${str})</span>`
            : str;
        }

        function displayMask(m){
          return showBinary
            ? `<span class="binary-val">${ipToBinary(m)}</span><span>(${m})</span>`
            : m;
        }

        results.innerHTML = `
          <div><strong><i class="fas fa-search"></i> 輸入 IP:</strong><span>${display(ipParts)}</span></div>
          <div><strong><i class="fas fa-bars"></i> 子網遮罩 (Mask):</strong><span>${displayMask(mask)}</span></div>
          <div><strong><i class="fas fa-divide"></i> 子網位元 (CIDR):</strong><span>/${prefix}</span></div>
          <div><strong><i class="fas fa-tag"></i> IP 類型:</strong><span>${isPrivateIP(ip)}</span></div>
          <div><strong><i class="fas fa-users"></i> 可用主機數量:</strong><span>${hostCount}</span></div>

          <div class="primary-result">
            <strong><i class="fas fa-home"></i> 網段位址 (Network ID):</strong>
            <span>${display(network)}</span>
          </div>

          <div class="primary-result">
            <strong><i class="fas fa-broadcast-tower"></i> 廣播位址 (Broadcast):</strong>
            <span>${display(broadcast)}</span>
          </div>

          <div class="primary-result">
            <strong><i class="fas fa-arrows-alt-h"></i> 可用主機範圍:</strong>
            <span>${display(hostMin)} - ${display(hostMax)}</span>
          </div>
        `;
      }

      function toggleBinary(){
        showBinary = !showBinary;

        document.getElementById('toggleBinaryButton').innerHTML =
          showBinary
          ? `<i class="fas fa-align-left"></i> 切換為十進位顯示`
          : `<i class="fas fa-exchange-alt"></i> 切換二進位顯示`;

        calculate();
      }
    </script>
</body>
</html>
